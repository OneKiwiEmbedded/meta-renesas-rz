From d2ed362c3fa926565619d5d6959a05c85ea946ae Mon Sep 17 00:00:00 2001
From: Tai Huynh <tai.huynh.cp@renesas.com>
Date: Wed, 18 May 2022 10:27:02 +0700
Subject: [PATCH] fixed-bug-auto-boot-when-no-serial

Signed-off-by: Tai Huynh <tai.huynh.cp@renesas.com>
---
 board/renesas/rzv2m-dev/rdk_pfc.c |  2 +-
 drivers/serial/serial_rzv2m.c     | 30 ++++++++++++------------------
 include/linux/serial_reg.h        |  2 +-
 3 files changed, 14 insertions(+), 20 deletions(-)

diff --git a/board/renesas/rzv2m-dev/rdk_pfc.c b/board/renesas/rzv2m-dev/rdk_pfc.c
index c8e14e96d6..1d25df87f2 100644
--- a/board/renesas/rzv2m-dev/rdk_pfc.c
+++ b/board/renesas/rzv2m-dev/rdk_pfc.c
@@ -585,7 +585,7 @@ static const st_pfc_select_port_info_t gl_pfc_select_emm[] = {
      .pin_map = 0x0CFFU,
      .pin_oe = 0x0000U,
      .pin_ie = 0x0000U,
-     .pin_pupd = 0x00505555,
+     .pin_pupd = 0x00000059,
      .pin_drv = 0x00505555,
      .pin_sr = 0x0CFFU},
 };
diff --git a/drivers/serial/serial_rzv2m.c b/drivers/serial/serial_rzv2m.c
index 5cb0b9e2d6..5efd060fba 100644
--- a/drivers/serial/serial_rzv2m.c
+++ b/drivers/serial/serial_rzv2m.c
@@ -162,25 +162,22 @@ uint32_t uart_trx_ready_poll(struct uart_port *port)
 	uint32_t sts;
 	uint32_t res = UART_STAT_NONE;
 
-	sts = uart_in(port,UART_LSR);					/** Read Line Status */
-	if((sts & UART_LSR_BRK_ERROR_BITS) != 0)		/** Error(FE/PE/OV) ? */
-	{
-		if((sts & UART_LSR_DR) != 0)	/** Rx rdy ? */
-		{
-			res = (UART_STAT_ERROR | UART_STAT_RX_READY);
-		}
-		else
-		{
-			res = (UART_STAT_ERROR);
-		}
+       sts = uart_in(port,UART_LSR);           /** Read Line Status */
+        if(sts & UART_LSR_ERROR_BITS)           /** Error(FE/PE/OV) ? */
+
+       {
+               uart_in(port,UART_RX);                  /*Dummy read*/
+                res = (UART_STAT_ERROR);
+
+
 	}
 	else
 	{
-		if((sts & UART_LSR_DR))				/** Rx rdy */
+		if((sts & UART_LSR_DR))                 /** Rx ready **/
 		{
 			res = (UART_STAT_RX_READY);
 		}
-		else if((sts & (UART_LSR_TEMT |UART_LSR_THRE)) == (UART_LSR_TEMT |UART_LSR_THRE))		/** Tx & Rx rdy */
+		else if((sts & (UART_LSR_TEMT |UART_LSR_THRE)) == (UART_LSR_TEMT |UART_LSR_THRE))       /** Tx & Rx ready **/
 		{
 			res = (UART_STAT_TX_READY);
 		}
@@ -194,14 +191,11 @@ static int rzv2m_serial_getc_generic(struct uart_port *port)
 	uint32_t sts;
 	
 	sts = uart_trx_ready_poll(port);
-	if(sts & UART_STAT_ERROR){
-		return -EAGAIN;
-	}
-	if(0 != (sts & UART_STAT_RX_READY))   /** Rxrdy ? */
+    if(sts & UART_STAT_RX_READY)   /** Rx ready ? */
     {
         return  uart_in(port,UART_RX);  /** Read Rx data */
     }
-    else
+    else /*UART_STAT_ERROR or UART_STAT_TX_READY or UART_STAT_NONE*/
     {
 		return -EAGAIN;
     }
diff --git a/include/linux/serial_reg.h b/include/linux/serial_reg.h
index 29c3b5b9a5..37d750e98c 100644
--- a/include/linux/serial_reg.h
+++ b/include/linux/serial_reg.h
@@ -129,7 +129,7 @@
 #define UART_LSR_PE		0x04 /* Parity error indicator */
 #define UART_LSR_OE		0x02 /* Overrun error indicator */
 #define UART_LSR_DR		0x01 /* Receiver data ready */
-#define UART_LSR_BRK_ERROR_BITS	0x1E /* BI, FE, PE, OE bits */
+#define UART_LSR_ERROR_BITS    0x9E /* FIFOE,BI, FE, PE, OE bits */
 
 #define UART_MSR	6	/* In:  Modem Status Register */
 #define UART_MSR_DCD		0x80 /* Data Carrier Detect */
-- 
2.25.1

